<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>GospodÄƒrie â€“ Dashboard ESP32</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Paho MQTT over WebSockets -->
    <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>

    <style>
        :root {
            --bg: #0b1f12;
            --card-bg: #12281a;
            --accent: #4caf50;
            --accent-soft: rgba(76, 175, 80, 0.2);
            --accent-red: #ff5252;
            --accent-yellow: #ffb300;
            --text-main: #e9f5ea;
            --text-soft: #c0d7c4;
            --border-soft: #27402d;
            --shadow-soft: 0 14px 35px rgba(0, 0, 0, 0.48);
            --radius-xl: 18px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #163820 0, #050b08 55%, #020403 100%);
            color: var(--text-main);
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px 12px 40px;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        header h1 {
            font-size: 1.4rem;
            margin: 0;
            letter-spacing: 0.04em;
        }

        .subtitle {
            font-size: 0.85rem;
            color: var(--text-soft);
            margin-top: 4px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            border: 1px solid var(--border-soft);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.24), transparent);
        }

        .pill-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #00e676;
            box-shadow: 0 0 8px rgba(0, 230, 118, 0.9);
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
            gap: 16px;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: radial-gradient(circle at top left, rgba(76, 175, 80, 0.18), transparent 60%),
                        radial-gradient(circle at bottom right, rgba(33, 150, 83, 0.12), transparent 55%),
                        var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 14px 16px 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-soft);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.05), transparent 55%);
            opacity: 0.8;
            pointer-events: none;
        }

        .card-content {
            position: relative;
            z-index: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.02rem;
            font-weight: 600;
        }

        .badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-soft);
            color: var(--text-soft);
        }

        .badge-online {
            border-color: rgba(76, 175, 80, 0.7);
            background: rgba(56, 142, 60, 0.25);
            color: #b9f6ca;
        }

        .badge-offline {
            border-color: rgba(255, 82, 82, 0.7);
            background: rgba(255, 82, 82, 0.12);
            color: #ff8a80;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .metrics-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .metric {
            background: rgba(0, 0, 0, 0.24);
            border-radius: 12px;
            padding: 6px 8px;
            border: 1px solid rgba(76, 175, 80, 0.18);
        }

        .metric-label {
            font-size: 0.72rem;
            color: var(--text-soft);
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .metric-value.small {
            font-size: 0.78rem;
            font-weight: 500;
        }

        .metric-tag {
            font-size: 0.72rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(0,0,0,0.4);
            display: inline-block;
            margin-top: 2px;
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        button {
            border-radius: 999px;
            border: 1px solid rgba(76, 175, 80, 0.45);
            padding: 5px 10px;
            font-size: 0.78rem;
            background: radial-gradient(circle at top, rgba(76, 175, 80, 0.2), rgba(0,0,0,0.6));
            color: var(--text-main);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease, border-color 0.1s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            border-color: rgba(129, 199, 132, 0.8);
        }

        button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-ghost {
            background: rgba(0,0,0,0.1);
        }

        .btn-red {
            border-color: rgba(255, 82, 82, 0.7);
            background: radial-gradient(circle at top, rgba(255, 82, 82, 0.2), rgba(0,0,0,0.7));
        }

        .btn-yellow {
            border-color: rgba(255, 179, 0, 0.7);
            background: radial-gradient(circle at top, rgba(255, 179, 0, 0.22), rgba(0,0,0,0.7));
        }

        .section-title {
            font-size: 0.88rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-soft);
            margin: 0 0 6px;
        }

        .log-box {
            background: rgba(0,0,0,0.45);
            border-radius: 12px;
            padding: 6px 8px;
            border: 1px solid rgba(76, 175, 80, 0.24);
            max-height: 200px;
            overflow-y: auto;
            font-family: "JetBrains Mono", "Fira Code", monospace;
            font-size: 0.7rem;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .log-line {
            opacity: 0.9;
        }

        .log-line.system {
            color: #9ccc65;
        }

        .log-line.warn {
            color: #ffb74d;
        }

        .log-line.err {
            color: #ff8a80;
        }

        .log-line.time {
            color: #90caf9;
        }

        .small-muted {
            font-size: 0.7rem;
            color: var(--text-soft);
            margin-top: 4px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border-radius: 999px;
            font-size: 0.7rem;
            padding: 2px 8px;
            border: 1px solid rgba(76, 175, 80, 0.35);
            background: rgba(0,0,0,0.4);
        }

        .chip-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ffb300;
        }

        .chip-ok .chip-dot {
            background: #00e676;
        }

        .chip-bad .chip-dot {
            background: #ff1744;
        }

        .topic {
            font-family: monospace;
            font-size: 0.7rem;
            color: var(--text-soft);
        }

        .footer-note {
            margin-top: 10px;
            font-size: 0.7rem;
            color: var(--text-soft);
        }

        .grid-devices {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
        @media (max-width: 850px) {
            .grid-devices {
                grid-template-columns: 1fr;
            }
        }

        .hint {
            font-size: 0.7rem;
            color: var(--text-soft);
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #616161;
            box-shadow: none;
            margin-left: 4px;
        }
        .status-dot.online {
            background: #00e676;
            box-shadow: 0 0 8px rgba(0, 230, 118, 0.9);
        }
        .status-dot.offline {
            background: #ff5252;
            box-shadow: 0 0 8px rgba(255, 82, 82, 0.9);
        }

    </style>
</head>
<body>
<div class="page">
    <header>
        <div>
            <h1>GospodÄƒrie â€“ Monitor senzori ESP32</h1>
            <div class="subtitle">
                CÄƒmarÄƒ È™i BucÄƒtÄƒrie &middot; Date live prin MQTT + ThingSpeak &middot; Alerte Telegram
            </div>
        </div>
        <div>
            <div class="pill">
                <span class="pill-dot" id="mqtt-pill-dot"></span>
                <span id="mqtt-status-label">MQTT: deconectat</span>
            </div>
        </div>
    </header>

    <div class="layout">
        <!-- STÃ‚NGA: Dispozitive -->
        <div class="card">
            <div class="card-content">
                <div class="card-header">
                    <div class="card-title">Dispozitive</div>
                    <div class="chip chip-ok" id="devices-summary-chip">
                        <span class="chip-dot"></span>
                        <span id="devices-summary-text">0 online / 2 total</span>
                    </div>
                </div>

                <div class="grid-devices" id="devices-grid">
                    <!-- Card CÄƒmarÄƒ -->
                    <div class="card" style="padding:10px 10px 12px; background: radial-gradient(circle at top left, rgba(76, 175, 80, 0.26), transparent 65%), var(--card-bg);">
                        <div class="card-content">
                            <div class="card-header" style="margin-bottom:6px;">
                                <div class="card-title">
                                    CÄƒmarÄƒ
                                    <span class="status-dot" id="dot-EC62609C8900"></span>
                                </div>
                                <span class="badge" id="badge-EC62609C8900">offline</span>
                            </div>

                            <div class="metrics-row">
                                <div class="metric">
                                    <div class="metric-label">TemperaturÄƒ</div>
                                    <div class="metric-value" id="temp-EC62609C8900">-- Â°C</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Umiditate</div>
                                    <div class="metric-value" id="hum-EC62609C8900">-- %</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Ultim status</div>
                                    <div class="metric-value small" id="status-EC62609C8900">â€”</div>
                                </div>
                            </div>

                            <div class="btn-row">
                                <button onclick="sendCmd('EC62609C8900','ping')">ðŸ“¡ Ping</button>
                                <button class="btn-yellow" onclick="sendCmd('EC62609C8900','run')">â–¶ Force Run</button>
                                <button class="btn-red" onclick="sendCmd('EC62609C8900','reboot')">âŸ² Reboot</button>
                            </div>

                            <div class="section-title" style="margin-top:6px;">Log CÄƒmarÄƒ</div>
                            <div class="log-box" id="log-EC62609C8900"></div>
                        </div>
                    </div>

                    <!-- Card BucÄƒtÄƒrie -->
                    <div class="card" style="padding:10px 10px 12px; background: radial-gradient(circle at top left, rgba(56, 142, 60, 0.26), transparent 65%), var(--card-bg);">
                        <div class="card-content">
                            <div class="card-header" style="margin-bottom:6px;">
                                <div class="card-title">
                                    BucÄƒtÄƒrie
                                    <span class="status-dot" id="dot-7821849F8900"></span>
                                </div>
                                <span class="badge" id="badge-7821849F8900">offline</span>
                            </div>

                            <div class="metrics-row">
                                <div class="metric">
                                    <div class="metric-label">TemperaturÄƒ</div>
                                    <div class="metric-value" id="temp-7821849F8900">-- Â°C</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Umiditate</div>
                                    <div class="metric-value" id="hum-7821849F8900">-- %</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Ultim status</div>
                                    <div class="metric-value small" id="status-7821849F8900">â€”</div>
                                </div>
                            </div>

                            <div class="btn-row">
                                <button onclick="sendCmd('7821849F8900','ping')">ðŸ“¡ Ping</button>
                                <button class="btn-yellow" onclick="sendCmd('7821849F8900','run')">â–¶ Force Run</button>
                                <button class="btn-red" onclick="sendCmd('7821849F8900','reboot')">âŸ² Reboot</button>
                            </div>

                            <div class="section-title" style="margin-top:6px;">Log BucÄƒtÄƒrie</div>
                            <div class="log-box" id="log-7821849F8900"></div>
                        </div>
                    </div>
                </div>

                <div class="small-muted">
                    Ultimul RUN OK actualizeazÄƒ temperatura È™i umiditatea extrase din mesajul MQTT de log.<br>
                    Topicuri ascultate: <span class="topic">/gosp/+/status</span>, <span class="topic">/gosp/+/log</span>.
                </div>
            </div>
        </div>

        <!-- DREAPTA: Comenzi globale + Info tehnic -->
        <div class="card">
            <div class="card-content">
                <div class="card-header">
                    <div class="card-title">Control &amp; Sistem</div>
                    <span class="badge">HiveMQ Cloud Â· WebSockets TLS</span>
                </div>

                <p class="hint">
                    PoÈ›i trimite comenzi instant cÄƒtre toate ESP32-urile sau doar cÄƒtre o camerÄƒ.
                    Comenzile folosesc MQTT Cloud, deci funcÈ›ioneazÄƒ È™i cÃ¢nd eÈ™ti Ã®n afara gospodÄƒriei.
                </p>

                <h3 class="section-title">Comenzi globale</h3>
                <div class="btn-row">
                    <button onclick="sendCmd('all','ping')">ðŸ“¡ Ping ALL</button>
                    <button class="btn-yellow" onclick="sendCmd('all','run')">â–¶ Force Run ALL</button>
                    <button class="btn-red" onclick="sendCmd('all','reboot')">âŸ² Reboot ALL</button>
                </div>

                <div class="small-muted">
                    Exemple topicuri:<br>
                    <span class="topic">/gosp/all/cmd/ping</span> Â·
                    <span class="topic">/gosp/EC62609C8900/cmd/reboot</span>
                </div>

                <hr style="border-color: rgba(255,255,255,0.06); margin: 10px 0;">

                <h3 class="section-title">Stare MQTT</h3>
                <div class="metric" style="margin-bottom:8px;">
                    <div class="metric-label">Client ID</div>
                    <div class="metric-value small" id="mqtt-client-id">â€”</div>
                </div>
                <div class="metric" style="margin-bottom:8px;">
                    <div class="metric-label">Ultimul eveniment</div>
                    <div class="metric-value small" id="mqtt-last-event">â€”</div>
                </div>

                <div class="section-title" style="margin-top:10px;">Log MQTT</div>
                <div class="log-box" id="log-mqtt"></div>

                <div class="footer-note">
                    Remote code: <span class="topic">remote.py</span> (GitHub) Â· Config: <span class="topic">ThingSpeak 1622205</span><br>
                    Date trimise Ã®n ThingSpeak DATA: <span class="topic">XP7PSBXSVN3CXWKQ / ZPT57WZJNMLGM2X1</span> (Ã®n ESP32).
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================
    // CONFIG MQTT WebSockets
    // ============================
    const MQTT_HOST = "c72cc38c1f184d0199cc4daa938bac6f.s1.eu.hivemq.cloud";
    const MQTT_PORT = 8884;                // WebSockets TLS
    const MQTT_PATH = "/mqtt";
    const MQTT_USER = "burlusi";
    const MQTT_PASS = "Burlusi166?";

    const BASE = "/gosp/";
    const STATUS_SUFFIX = "/status";
    const LOG_SUFFIX = "/log";
    const CMD_PREFIX = "/cmd/";

    // Dispozitivele cunoscute (deviceId -> nume)
    const DEVICES = {
        "EC62609C8900": { name: "CÄƒmarÄƒ" },
        "7821849F8900": { name: "BucÄƒtÄƒrie" }
    };

    // stare UI per device
    const state = {
        "EC62609C8900": {
            online: false,
            lastStatus: "",
            lastTemp: null,
            lastHum: null
        },
        "7821849F8900": {
            online: false,
            lastStatus: "",
            lastTemp: null,
            lastHum: null
        }
    };

    let client = null;
    let reconnectTimeout = null;
    let clientId = "WEB_" + Math.random().toString(16).slice(2, 10).toUpperCase();

    document.getElementById("mqtt-client-id").textContent = clientId;

    function logMqtt(msg, level="") {
        const box = document.getElementById("log-mqtt");
        const line = document.createElement("div");
        line.className = "log-line " + (level || "system");
        const ts = new Date().toLocaleTimeString("ro-RO", {hour12:false});
        line.textContent = `[${ts}] ${msg}`;
        box.appendChild(line);
        box.scrollTop = box.scrollHeight;
        document.getElementById("mqtt-last-event").textContent = msg;
    }

    function logDevice(deviceId, msg, level="") {
        const box = document.getElementById("log-" + deviceId);
        if (!box) return;
        const line = document.createElement("div");
        line.className = "log-line " + (level || "system");
        const ts = new Date().toLocaleTimeString("ro-RO", {hour12:false});
        line.textContent = `[${ts}] ${msg}`;
        box.appendChild(line);
        box.scrollTop = box.scrollHeight;
    }

    function updateDevicesSummary() {
        let onlineCount = 0;
        let total = Object.keys(DEVICES).length;
        Object.keys(DEVICES).forEach(id => {
            if (state[id] && state[id].online) onlineCount++;
        });

        const chip = document.getElementById("devices-summary-chip");
        const txt = document.getElementById("devices-summary-text");

        txt.textContent = `${onlineCount} online / ${total} total`;
        chip.classList.remove("chip-ok", "chip-bad");
        if (onlineCount === 0) {
            chip.classList.add("chip-bad");
        } else {
            chip.classList.add("chip-ok");
        }
    }

    function setDeviceOnline(deviceId, online) {
        if (!state[deviceId]) return;
        state[deviceId].online = online;

        const badge = document.getElementById("badge-" + deviceId);
        const dot = document.getElementById("dot-" + deviceId);
        if (!badge || !dot) return;

        if (online) {
            badge.textContent = "online";
            badge.classList.remove("badge-offline");
            badge.classList.add("badge-online");
            dot.classList.remove("offline");
            dot.classList.add("online");
        } else {
            badge.textContent = "offline";
            badge.classList.remove("badge-online");
            badge.classList.add("badge-offline");
            dot.classList.remove("online");
            dot.classList.add("offline");
        }
        updateDevicesSummary();
    }

    function parseLogForTempHum(deviceId, msg) {
        // CÄƒutÄƒm pattern RUN OK T=xx H=yy sau similar
        // Ex: "RUN OK T=25 H=47"
        const m = msg.match(/T\s*=\s*([0-9]+(?:\.[0-9]+)?)\s*H\s*=\s*([0-9]+(?:\.[0-9]+)?)/i);
        if (m) {
            const t = parseFloat(m[1]);
            const h = parseFloat(m[2]);
            state[deviceId].lastTemp = t;
            state[deviceId].lastHum  = h;
            const tempEl = document.getElementById("temp-" + deviceId);
            const humEl  = document.getElementById("hum-" + deviceId);
            if (tempEl) tempEl.textContent = `${t.toFixed(1)} Â°C`;
            if (humEl)  humEl.textContent  = `${h.toFixed(0)} %`;
        }
    }

    // ============================
    // MQTT â€“ onMessage
    // ============================
    function onMessageArrived(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;

        logMqtt(`MQTT msg: ${topic} = ${payload}`, "system");

        // status: /gosp/<DEVICE_ID>/status
        if (topic.startsWith(BASE) && topic.endsWith(STATUS_SUFFIX)) {
            const deviceId = topic.slice(BASE.length, topic.length - STATUS_SUFFIX.length);
            if (!DEVICES[deviceId]) return;
            setDeviceOnline(deviceId, true);
            state[deviceId].lastStatus = payload;
            const el = document.getElementById("status-" + deviceId);
            if (el) el.textContent = payload;
            logDevice(deviceId, `STATUS: ${payload}`, "system");
            return;
        }

        // log: /gosp/<DEVICE_ID>/log
        if (topic.startsWith(BASE) && topic.endsWith(LOG_SUFFIX)) {
            const deviceId = topic.slice(BASE.length, topic.length - LOG_SUFFIX.length);
            if (!DEVICES[deviceId]) return;
            setDeviceOnline(deviceId, true);
            logDevice(deviceId, payload, "system");
            parseLogForTempHum(deviceId, payload);
            return;
        }
    }

    // ============================
    // MQTT â€“ connect & reconnect
    // ============================
    function onConnect() {
        logMqtt("Conectat la MQTT Cloud");
        const pill = document.getElementById("mqtt-pill-dot");
        pill.classList.add("online");
        document.getElementById("mqtt-status-label").textContent = "MQTT: conectat";

        // Subscribe la status + log pentru toate device-urile
        if (client) {
            client.subscribe(BASE + "+/status");
            client.subscribe(BASE + "+/log");
            logMqtt("Subscribed: " + BASE + "+/status, " + BASE + "+/log");
        }

        // dupÄƒ conectare, presupunem offline pÃ¢nÄƒ primim status/log
        Object.keys(DEVICES).forEach(id => setDeviceOnline(id, false));
    }

    function onConnectionLost(response) {
        logMqtt("Conexiune MQTT pierdutÄƒ", "warn");
        const pill = document.getElementById("mqtt-pill-dot");
        pill.classList.remove("online");
        document.getElementById("mqtt-status-label").textContent = "MQTT: deconectat";

        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        reconnectTimeout = setTimeout(connectMqtt, 3000);
    }

    function connectMqtt() {
        logMqtt("Conectare la HiveMQ WebSockets...");
        const pill = document.getElementById("mqtt-pill-dot");
        pill.classList.remove("online");
        document.getElementById("mqtt-status-label").textContent = "MQTT: conectare...";

        client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, MQTT_PATH, clientId);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        const options = {
            useSSL: true,
            userName: MQTT_USER,
            password: MQTT_PASS,
            timeout: 8,
            cleanSession: true,
            onSuccess: onConnect,
            onFailure: function (err) {
                logMqtt("Eroare conectare MQTT: " + err.errorMessage, "err");
                const pill = document.getElementById("mqtt-pill-dot");
                pill.classList.remove("online");
                document.getElementById("mqtt-status-label").textContent = "MQTT: eroare";
                if (reconnectTimeout) clearTimeout(reconnectTimeout);
                reconnectTimeout = setTimeout(connectMqtt, 5000);
            }
        };

        try {
            client.connect(options);
        } catch (e) {
            logMqtt("Exceptie conectare MQTT: " + e, "err");
            if (reconnectTimeout) clearTimeout(reconnectTimeout);
            reconnectTimeout = setTimeout(connectMqtt, 5000);
        }
    }

    // ============================
    // Trimite comenzi
    // ============================
    function sendCmd(deviceId, cmd) {
        if (!client || !client.isConnected()) {
            logMqtt("Nu pot trimite cmd, MQTT nu este conectat.", "warn");
            alert("MQTT nu este conectat.");
            return;
        }

        let topic;
        if (deviceId === "all") {
            topic = BASE + "all" + CMD_PREFIX + cmd;
        } else {
            topic = BASE + deviceId + CMD_PREFIX + cmd;
        }

        const msg = new Paho.MQTT.Message("1");
        msg.destinationName = topic;

        try {
            client.send(msg);
            logMqtt("Trimis CMD: " + topic, "system");
        } catch (e) {
            logMqtt("Eroare trimitere CMD: " + e, "err");
        }
    }

    // ============================
    // Start
    // ============================
    window.addEventListener("load", () => {
        connectMqtt();
    });
</script>
</body>
</html>
