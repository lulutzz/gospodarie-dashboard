<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Panou Control ESP32 – MQTT2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
<style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; background: #0f172a; color: #fff; }
    .sidebar { width: 220px; background: #1e293b; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
    .main { flex: 1; padding: 20px; background: #0f172a; }
    h1 { margin-top: 0; }
    .card { background: #111827; border: 1px solid #334155; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
    .id { font-weight: bold; font-size: 1.1em; }
    .status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: gray; margin-left: 6px; }
    .status.online { background: #22c55e; }
    .status.offline { background: #f43f5e; }
    .btn { padding: 6px 12px; margin: 6px 4px 0 0; border: none; border-radius: 6px; background: #0ea5e9; color: #000; cursor: pointer; font-weight: bold; }
</style>
</head>
<body>
<div class="sidebar">
  <h2>Dispozitive ESP32</h2>
  <div id="devices"></div>
</div>
<div class="main">
  <h1>Panou Control Gospodărie</h1>
  <p>Status live & comenzi prin MQTT – HiveMQ Cloud</p>
</div>
<script>
const devices = {};  // va conține toate cardurile per dispozitiv
const container = document.getElementById("devices");

function createCard(id) {
  const card = document.createElement("div");
  card.className = "card";

  const label = document.createElement("div");
  label.innerHTML = `<span class="id">${id}</span> <span class="status" id="status-${id}"></span>`;
  card.appendChild(label);

  const log = document.createElement("div");
  log.id = "log-" + id;
  log.style.fontSize = "0.8em";
  log.style.opacity = 0.6;
  log.style.marginTop = "4px";
  log.innerText = "...";
  card.appendChild(log);

  const btns = ["ping", "reboot", "reset"];
  btns.forEach(cmd => {
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.innerText = cmd[0].toUpperCase() + cmd.slice(1);
    btn.onclick = () => {
      const topic = `home/${id}/cmd/${cmd}`;
      const msg = new Paho.MQTT.Message("from web");
      msg.destinationName = topic;
      client.send(msg);
    };
    card.appendChild(btn);
  });

  container.appendChild(card);
  devices[id] = card;
}

function updateStatus(id, isOnline) {
  const el = document.getElementById("status-" + id);
  if (!el) return;
  el.className = "status " + (isOnline ? "online" : "offline");
}

function updateLog(id, msg) {
  const el = document.getElementById("log-" + id);
  if (el) el.innerText = msg;
}

const client = new Paho.MQTT.Client(
  "c72cc38c1f184d0199cc4daa938bac6f.s1.eu.hivemq.cloud",
  8884,
  "/mqtt",
  "webclient_" + Math.random().toString(16).substr(2, 8)
);

client.onConnectionLost = err => console.error("Pierdut conexiunea:", err);

client.onMessageArrived = msg => {
  const topic = msg.destinationName;
  const payload = msg.payloadString;
  const match = topic.match(/^home\/(.*?)\/(status|sensors|log)$/);
  if (!match) return;
  const [_, id, type] = match;
  if (!devices[id]) createCard(id);
  if (type === "status") updateStatus(id, payload === "online");
  if (type === "log") updateLog(id, payload);
};

client.connect({
  useSSL: true,
  userName: "burlusi",
  password: "Burlusi166?",
  onSuccess: () => {
    client.subscribe("home/+/status");
    client.subscribe("home/+/log");
  }
});
</script>
</body>
</html>
