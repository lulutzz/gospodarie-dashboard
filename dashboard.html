<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Gospodărie – Dashboard ESP32</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>

<style>
body { background:#08140c; color:#e6f5ea; font-family:Arial; margin:0; }
.card { background:#12281a; padding:16px; border-radius:14px; margin-bottom:16px; }
.btn { padding:6px 12px; border-radius:20px; cursor:pointer; border:1px solid #4caf50; margin-right:6px; }
.btn-yellow { border-color:#ffb300; }
.btn-red { border-color:#ff5252; }
.log { background:#000; padding:10px; border-radius:12px; height:180px; overflow:auto; font-size:12px; }
.status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-left:6px; }
.online { background:#00e676; box-shadow:0 0 6px #00e676; }
.offline { background:#ff5252; box-shadow:0 0 6px #ff5252; }
</style>
</head>

<body>

<h2 style="padding:16px;">Dashboard ESP32 – Control Direct</h2>

<div class="card">
  <h3>Cămară <span id="dot-EC62609C8900" class="status-dot offline"></span></h3>
  <button class="btn" onclick="sendCmd('EC62609C8900','ping')">Ping</button>
  <button class="btn btn-yellow" onclick="sendCmd('EC62609C8900','run')">Run</button>
  <button class="btn btn-red" onclick="sendCmd('EC62609C8900','reboot')">Reboot</button>
  <div class="log" id="log-EC62609C8900"></div>
</div>

<div class="card">
  <h3>Bucătărie <span id="dot-7821849F8900" class="status-dot offline"></span></h3>
  <button class="btn" onclick="sendCmd('7821849F8900','ping')">Ping</button>
  <button class="btn btn-yellow" onclick="sendCmd('7821849F8900','run')">Run</button>
  <button class="btn btn-red" onclick="sendCmd('7821849F8900','reboot')">Reboot</button>
  <div class="log" id="log-7821849F8900"></div>
</div>

<div class="card">
  <h3>MQTT Log</h3>
  <div class="log" id="log-mqtt"></div>
</div>

<script>
const HOST = "c72cc38c1f184d0199cc4daa938bac6f.s1.eu.hivemq.cloud";
const PORT = 8884;
const PATH = "/mqtt";
const USER = "burlusi";
const PASS = "Burlusi166?";
const BASE = "/gosp/";
const DEVICES = ["EC62609C8900","7821849F8900"];

let client = null;
let clientId = "WEB_" + Math.random().toString(16).substr(2,6);

function logMQTT(msg){
  let box=document.getElementById("log-mqtt");
  box.innerHTML += msg+"\n";
  box.scrollTop = box.scrollHeight;
}

function logDev(id,msg){
  let box=document.getElementById("log-"+id);
  box.innerHTML += msg+"\n";
  box.scrollTop = box.scrollHeight;
}

function setDot(id, online){
  let dot=document.getElementById("dot-"+id);
  dot.classList.remove("online","offline");
  dot.classList.add(online?"online":"offline");
}

function connectMQTT(){
  client = new Paho.MQTT.Client(HOST, PORT, PATH, clientId);
  client.onConnectionLost = ()=>logMQTT("Conexiune pierdută");
  client.onMessageArrived = onMsg;

  client.connect({
    useSSL:true, userName:USER, password:PASS,
    onSuccess:()=>{
      logMQTT("Conectat MQTT");
      DEVICES.forEach(id=>{
        client.subscribe(BASE+id+"/log");
        client.subscribe(BASE+id+"/status");
        client.subscribe(BASE+id+"/cmd/ack");
      });
    },
    onFailure:(e)=>logMQTT("Eroare conectare: "+e.errorMessage)
  });
}

function onMsg(m){
  let t=m.destinationName, p=m.payloadString;
  logMQTT(t+" = "+p);

  // status
  DEVICES.forEach(id=>{
    if(t === BASE+id+"/status"){ setDot(id,true); logDev(id,"STATUS: "+p); }
    if(t === BASE+id+"/log"){ setDot(id,true); logDev(id,p); }
    if(t === BASE+id+"/cmd/ack"){ logDev(id,"ACK: "+p); }
  });
}

function sendCmd(id,cmd){
  if(!client.isConnected()) return alert("MQTT nu e conectat");

  let topic = BASE + id + "/cmd/" + cmd;
  let msg = new Paho.MQTT.Message("1");
  msg.destinationName = topic;

  client.send(msg);
  logMQTT("Trimis: "+topic);

  // subscribe ACK
  client.subscribe(BASE+id+"/cmd/ack");
}

window.onload = connectMQTT;
</script>

</body>
</html>
