<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>ESP32 Dashboard â€“ Comenzi cu ACK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>

    <style>
        body { background:#0b1f12; color:#e9f5ea; font-family:Arial; margin:0; }
        h1 { margin:0 0 10px; }
        .page { max-width:1000px; margin:auto; padding:20px; }

        .card {
            background:#12281a;
            padding:15px;
            border-radius:14px;
            margin-bottom:12px;
            border:1px solid #27402d;
        }

        .device-title {
            font-size:1.2rem;
            display:flex;
            justify-content:space-between;
            margin-bottom:6px;
        }

        .status-dot {
            width:10px; height:10px; border-radius:50%;
            background:#555;
        }
        .status-dot.online { background:#00e676; box-shadow:0 0 6px #00e676; }
        .status-dot.offline { background:#ff5252; box-shadow:0 0 6px #ff5252; }

        button {
            padding:6px 12px;
            margin-right:6px;
            border-radius:12px;
            border:1px solid #4caf50;
            background:#1a3d26;
            color:white;
            cursor:pointer;
        }
        button:hover { background:#2a5d36; }
        button.red { border-color:#ff5252; }
        button.yellow { border-color:#ffb300; }

        .log-box {
            background:#00000060;
            border:1px solid #27402d;
            padding:8px;
            margin-top:10px;
            height:140px;
            overflow-y:auto;
            font-size:0.8rem;
            white-space:pre-wrap;
            border-radius:10px;
        }

        #mqtt-status { margin-bottom:14px; }
    </style>
</head>

<body>
<div class="page">

    <h1>ESP32 Dashboard â€“ Control Direct</h1>

    <div id="mqtt-status">ðŸ”´ MQTT: deconectat</div>

    <!-- Camara -->
    <div class="card">
        <div class="device-title">
            CÄƒmarÄƒ
            <span id="dot-EC62609C8900" class="status-dot"></span>
        </div>

        <button onclick="sendCmd('EC62609C8900','ping')">Ping</button>
        <button class="yellow" onclick="sendCmd('EC62609C8900','run')">Run</button>
        <button class="red" onclick="sendCmd('EC62609C8900','reboot')">Reboot</button>

        <div class="log-box" id="log-EC62609C8900"></div>
    </div>

    <!-- Bucatarie -->
    <div class="card">
        <div class="device-title">
            BucÄƒtÄƒrie
            <span id="dot-7821849F8900" class="status-dot"></span>
        </div>

        <button onclick="sendCmd('7821849F8900','ping')">Ping</button>
        <button class="yellow" onclick="sendCmd('7821849F8900','run')">Run</button>
        <button class="red" onclick="sendCmd('7821849F8900','reboot')">Reboot</button>

        <div class="log-box" id="log-7821849F8900"></div>
    </div>

    <div class="card">
        <h3>Log MQTT</h3>
        <div class="log-box" id="log-mqtt"></div>
    </div>

</div>

<script>
const HOST = "c72cc38c1f184d0199cc4daa938bac6f.s1.eu.hivemq.cloud";
const PORT = 8884;
const PATH = "/mqtt";
const USER = "burlusi";
const PASS = "Burlusi166?";
const BASE = "/gosp/";
const CMD = "/cmd/";
const ACK = "/ack";
const STATUS = "/status";
const LOG = "/log";

let client = null;
let clientId = "WEB_" + Math.random().toString(16).substr(2,8);

function log(boxId, msg) {
    const box = document.getElementById(boxId);
    const t = new Date().toLocaleTimeString();
    box.textContent += `[${t}] ${msg}\n`;
    box.scrollTop = box.scrollHeight;
}

function setOnline(id, online) {
    let dot = document.getElementById("dot-" + id);
    dot.classList.remove("online","offline");
    dot.classList.add(online ? "online" : "offline");
}

function connectMQTT() {
    client = new Paho.MQTT.Client(HOST, PORT, PATH, clientId);
    client.onConnectionLost = () => {
        document.getElementById("mqtt-status").textContent = "ðŸ”´ MQTT: deconectat";
        setTimeout(connectMQTT, 2000);
    };

    client.onMessageArrived = onMsg;

    client.connect({
        useSSL:true,
        userName:USER,
        password:PASS,
        timeout:8,
        keepAliveInterval:20,
        onSuccess:() => {
            document.getElementById("mqtt-status").textContent = "ðŸŸ¢ MQTT: conectat";

            client.subscribe(BASE + "+/status");
            client.subscribe(BASE + "+/log");
            client.subscribe(BASE + "+/cmd/ack");
        }
    });
}

function onMsg(msg) {
    log("log-mqtt", msg.destinationName + " = " + msg.payloadString);

    if (msg.destinationName.endsWith("/status")) {
        let id = msg.destinationName.split("/")[2];
        setOnline(id, true);
    }

    if (msg.destinationName.endsWith("/log")) {
        let id = msg.destinationName.split("/")[2];
        log("log-" + id, msg.payloadString);
    }

    if (msg.destinationName.endsWith("/ack")) {
        let id = msg.destinationName.split("/")[2];
        log("log-" + id, "ACK: " + msg.payloadString);
    }
}

function sendCmd(deviceId, cmd) {
    if (!client || !client.isConnected()) {
        alert("MQTT nu este conectat!");
        return;
    }
    let topic = BASE + deviceId + CMD + cmd;
    let ackTopic = BASE + deviceId + CMD + "ack";

    client.subscribe(ackTopic);
    client.send(new Paho.MQTT.Message("1").setDestinationName(topic));

    log("log-" + deviceId, "Trimis CMD: " + cmd);

    setTimeout(() => {
        log("log-" + deviceId, "âš  Timeout ACK pentru cmd " + cmd);
    }, 4000);
}

connectMQTT();
</script>
</body>
</html>
