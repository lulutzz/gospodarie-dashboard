<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Panou de control MQTT</title>
  <!-- Include Paho MQTT JS from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
</head>
<body>
  <h1>Panou de control pentru dispozitivul 7821849F8900</h1>
  <p>Stare conexiune: <span id="statusIndicator">ðŸ”´ Deconectat</span></p>
  <!-- Butoane pentru comenzi -->
  <button id="pingBtn">Ping</button>
  <button id="runBtn">Run</button>
  <button id="rebootBtn">Reboot</button>
  <!-- Zone de afiÈ™are a mesajelor MQTT -->
  <h2>Mesaje status</h2>
  <div id="statusLog"></div>
  <h2>Mesaje log</h2>
  <div id="logLog"></div>

  <script>
    // 1. IniÈ›ializare client MQTT È™i conectare la HiveMQ Cloud
    const clientId = "mqtt_web_" + Math.floor(Math.random() * 1000000);  // ID unic
    const client = new Paho.MQTT.Client(
      "wss://c72cc38c1f184d0199cc4daa938bac6f.s1.eu.hivemq.cloud:8884/mqtt",
      clientId
    );

    // 2. Actualizarea indicatorului de status
    function updateStatusIndicator(connected) {
      const statusEl = document.getElementById('statusIndicator');
      statusEl.textContent = connected ? "ðŸŸ¢ Conectat" : "ðŸ”´ Deconectat";
    }

    // Callback: conexiune pierdutÄƒ
    client.onConnectionLost = function(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.error("Conexiune pierdutÄƒ: " + responseObject.errorMessage);
      }
      updateStatusIndicator(false);  // marcat ca deconectat
    };

    // Callback: mesaj sosit
    client.onMessageArrived = function(message) {
      const topic = message.destinationName;
      const payload = message.payloadString;
      if (topic === "/gosp/7821849F8900/status") {
        document.getElementById('statusLog').innerHTML += payload + "<br>";
      } else if (topic === "/gosp/7821849F8900/log") {
        document.getElementById('logLog').innerHTML += payload + "<br>";
      }
    };

    // Conectare la broker cu credentiale
    client.connect({
      useSSL: true,
      userName: "burlusi",
      password: "Burlusi166?",
      onSuccess: function() {
        console.log("Conectat la broker.");
        updateStatusIndicator(true);
        // 3. Abonare la topicurile de status È™i log dupÄƒ conectare
        client.subscribe("/gosp/7821849F8900/status");
        client.subscribe("/gosp/7821849F8900/log");
      },
      onFailure: function(error) {
        console.error("Eroare la conectare: " + error.errorMessage);
        updateStatusIndicator(false);
      }
    });

    // 4. Trimiterea comenzilor MQTT la apÄƒsarea butoanelor
    document.getElementById('pingBtn').onclick = function() {
      const msg = new Paho.MQTT.Message("");
      msg.destinationName = "/gosp/7821849F8900/cmd/ping";
      client.send(msg);
    };
    document.getElementById('runBtn').onclick = function() {
      const msg = new Paho.MQTT.Message("");
      msg.destinationName = "/gosp/7821849F8900/cmd/run";
      client.send(msg);
    };
    document.getElementById('rebootBtn').onclick = function() {
      const msg = new Paho.MQTT.Message("");
      msg.destinationName = "/gosp/7821849F8900/cmd/reboot";
      client.send(msg);
    };
  </script>
</body>
</html>
